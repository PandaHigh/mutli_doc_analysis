<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务分析结果 - 多文档分析系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .result-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .result-title {
            color: #0d6efd;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        .field-item {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.25rem;
            background-color: white;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
        }
        .relation-item {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            background-color: white;
        }
        .rule-item {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            background-color: white;
        }
        .score-high {
            color: #198754;
            font-weight: bold;
        }
        .score-medium {
            color: #ffc107;
            font-weight: bold;
        }
        .score-low {
            color: #dc3545;
            font-weight: bold;
        }
        .explicit-rule {
            border-left: 4px solid #0d6efd;
        }
        .implicit-rule {
            border-left: 4px solid #6c757d;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>任务分析结果</h1>
            <div>
                <a th:href="@{/}" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-arrow-left"></i> 返回首页
                </a>
                <a th:href="@{/task/{id}(id=${task.id})}" class="btn btn-outline-primary">
                    <i class="bi bi-info-circle"></i> 任务详情
                </a>
            </div>
        </div>

        <div class="alert alert-info">
            <h4 class="alert-heading" th:text="${task.taskName}">任务名称</h4>
            <p>创建时间: <span th:text="${#temporals.format(task.createdTime, 'yyyy-MM-dd HH:mm:ss')}">2023-01-01 12:00:00</span></p>
            <p>状态: <span class="badge bg-success">已完成</span></p>
        </div>

        <div th:if="${result != null}" class="result-section">
            <h2 class="result-title">分析摘要</h2>
            <div class="alert alert-success">
                <p th:text="${result.summary}">分析摘要内容</p>
            </div>
        </div>

        <div th:if="${result != null}" class="result-section">
            <h2 class="result-title">字段分析</h2>
            <div th:if="${result.resultJson != null}" id="fields-container">
                <!-- 字段内容将通过JavaScript动态加载 -->
            </div>
            <div th:if="${result.resultJson == null}" class="alert alert-warning">
                <p>没有可用的字段分析数据</p>
            </div>
        </div>

        <div th:if="${result != null}" class="result-section">
            <h2 class="result-title">字段关系</h2>
            <div th:if="${result.resultJson != null}" id="relations-container">
                <!-- 字段关系将通过JavaScript动态加载 -->
            </div>
            <div th:if="${result.resultJson == null}" class="alert alert-warning">
                <p>没有可用的字段关系数据</p>
            </div>
        </div>

        <div th:if="${result != null}" class="result-section">
            <h2 class="result-title">字段规则</h2>
            <div th:if="${result.resultJson != null}" id="rules-container">
                <!-- 字段规则将通过JavaScript动态加载 -->
            </div>
            <div th:if="${result.resultJson == null}" class="alert alert-warning">
                <p>没有可用的字段规则数据</p>
            </div>
        </div>

        <div th:if="${result != null && result.errorMessage != null}" class="result-section">
            <h2 class="result-title">错误信息</h2>
            <div class="alert alert-danger">
                <p th:text="${result.errorMessage}">错误信息内容</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:if="${result != null && result.resultJson != null}">
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const resultData = JSON.parse(/*[[${result.resultJson}]]*/ '{}');
                
                // 渲染字段分析
                if (resultData.report && resultData.report.fields) {
                    const fieldsContainer = document.getElementById('fields-container');
                    resultData.report.fields.forEach(field => {
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'field-item';
                        fieldDiv.innerHTML = `
                            <h5>${field.name}</h5>
                            <p>${field.description || '无描述'}</p>
                            <div class="mt-2">
                                <strong>相关文本:</strong>
                                <p class="mt-1">${field.relatedText || '无相关文本'}</p>
                            </div>
                        `;
                        fieldsContainer.appendChild(fieldDiv);
                    });
                }
                
                // 渲染字段关系
                if (resultData.report && resultData.report.relations) {
                    const relationsContainer = document.getElementById('relations-container');
                    resultData.report.relations.forEach(relation => {
                        const scoreClass = relation.score >= 0.7 ? 'score-high' : 
                                          (relation.score >= 0.4 ? 'score-medium' : 'score-low');
                        
                        const relationDiv = document.createElement('div');
                        relationDiv.className = 'relation-item';
                        relationDiv.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <span>${relation.sourceField} → ${relation.targetField}</span>
                                <span class="${scoreClass}">${(relation.score * 100).toFixed(1)}%</span>
                            </div>
                            <p class="mt-1 mb-0">${relation.description || '无描述'}</p>
                        `;
                        relationsContainer.appendChild(relationDiv);
                    });
                }
                
                // 渲染字段规则
                if (resultData.compiledRules) {
                    const rulesContainer = document.getElementById('rules-container');
                    
                    // 按字段分组规则
                    const fieldRules = {};
                    Object.keys(resultData.compiledRules).forEach(fieldName => {
                        fieldRules[fieldName] = resultData.compiledRules[fieldName];
                    });
                    
                    // 渲染每个字段的规则
                    Object.keys(fieldRules).forEach(fieldName => {
                        const fieldRulesDiv = document.createElement('div');
                        fieldRulesDiv.className = 'mb-3';
                        fieldRulesDiv.innerHTML = `<h5>${fieldName}</h5>`;
                        
                        fieldRules[fieldName].forEach(rule => {
                            const ruleTypeClass = rule.type === 'explicit' ? 'explicit-rule' : 'implicit-rule';
                            const ruleTypeText = rule.type === 'explicit' ? '显式规则' : '隐含规则';
                            
                            const ruleDiv = document.createElement('div');
                            ruleDiv.className = `rule-item ${ruleTypeClass} p-2`;
                            ruleDiv.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <span>${ruleTypeText}</span>
                                    <span>优先级: ${rule.priority}</span>
                                </div>
                                <p class="mt-1 mb-0">${rule.content}</p>
                            `;
                            fieldRulesDiv.appendChild(ruleDiv);
                        });
                        
                        rulesContainer.appendChild(fieldRulesDiv);
                    });
                }
            } catch (error) {
                console.error('解析结果数据时出错:', error);
                document.querySelectorAll('.result-section').forEach(section => {
                    section.innerHTML += '<div class="alert alert-danger">解析结果数据时出错</div>';
                });
            }
        });
    </script>
</body>
</html> 