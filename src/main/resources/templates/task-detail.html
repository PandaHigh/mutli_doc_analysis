<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务详情 - 多文档分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .progress {
            height: 25px;
        }
        .step-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .step-item.completed {
            background-color: #d4edda;
        }
        .step-item.in-progress {
            background-color: #cce5ff;
        }
        .step-item.pending {
            background-color: #f8f9fa;
            opacity: 0.7;
        }
        .step-details {
            margin-top: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .step-status {
            font-weight: bold;
        }
        .step-status.completed {
            color: #28a745;
        }
        .step-status.in-progress {
            color: #007bff;
        }
        .step-status.pending {
            color: #6c757d;
        }
        .step-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .log-timestamp {
            color: #6c757d;
            font-size: 0.9em;
        }
        .log-step {
            font-weight: bold;
            color: #0d6efd;
        }
        .step-card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        .status-in-progress {
            background-color: #cce5ff;
            color: #004085;
        }
        .status-pending {
            background-color: #f8f9fa;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">多文档分析系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/new-task">新建任务</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">任务详情</h5>
                        <div>
                            <a th:if="${task.status == T(com.example.multidoc.model.AnalysisTask.TaskStatus).COMPLETED}" 
                               th:href="@{/task/{id}/result(id=${task.id})}" 
                               class="btn btn-success me-2">
                                <i class="fas fa-chart-bar"></i> 查看结果
                            </a>
                            <a href="/" class="btn btn-outline-primary">返回列表</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <span th:text="${message}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <!-- 任务基本信息 -->
                        <div class="card step-card">
                        <div class="task-info mb-4">
                            <h4 th:text="${task.taskName}"></h4>
                            <div class="row mt-3">
                                <div class="col-md-3 mb-2">
                                    <strong>任务ID:</strong> <span th:text="${task.id}"></span>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <strong>创建时间:</strong> <span th:text="${#temporals.format(task.createdTime, 'yyyy-MM-dd HH:mm:ss')}"></span>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <strong>状态:</strong>
                                    <span th:if="${task.status.name() == 'CREATED'}" class="badge bg-secondary">等待处理</span>
                                    <span th:if="${task.status.name() == 'PROCESSING'}" class="badge bg-primary">处理中</span>
                                    <span th:if="${task.status.name() == 'COMPLETED'}" class="badge bg-success">已完成</span>
                                    <span th:if="${task.status.name() == 'FAILED'}" class="badge bg-danger">失败</span>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <strong>文件数量:</strong>
                                    <span th:with="step1=${progress.steps[0]},step2=${progress.steps[1]}">
                                        <span th:text="${step1.details.totalFiles} + ' Word'"></span>,
                                        <span th:text="${step2.details.totalFiles} + ' Excel'"></span>
                                        <span th:if="${task.status.name() == 'PROCESSING'}" class="text-muted">
                                            (已处理: <span th:text="${step1.details.processedFiles} + ' Word, ' + ${step2.details.totalFields} + ' 字段'"></span>)
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- 进度显示区域 -->
                        <div class="card mb-4" id="progressCard" th:if="${task.status != 'COMPLETED' && task.status != 'FAILED'}">
                            <div class="card-header">
                                <h3>分析进度</h3>
                            </div>
                            <div class="card-body">
                                <div class="progress mb-4">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: 0%"
                                         id="progressBar">0%</div>
                                </div>
                                
                                <div id="stepsContainer">
                                    <!-- 步骤将通过JavaScript动态添加 -->
                                </div>
                            </div>
                        </div>

                        <!-- 失败状态 -->
                        <div th:if="${task.status.name() == 'FAILED' && result != null}" class="mb-4">
                            <div class="alert alert-danger">
                                <h5 class="alert-heading">处理失败</h5>
                                <p th:text="${result.errorMessage}"></p>
                            </div>
                        </div>

                        <!-- 分析结果 -->
                        <div th:if="${task.status.name() == 'COMPLETED' && result != null}" class="analysis-result">
                            <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">结果摘要</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab">字段规则</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="relations-tab" data-bs-toggle="tab" data-bs-target="#relations" type="button" role="tab">字段关系</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw" type="button" role="tab">原始JSON</button>
                                </li>
                            </ul>
                            <div class="tab-content p-3 border border-top-0 rounded-bottom" id="resultTabsContent">
                                <!-- 结果摘要 -->
                                <div class="tab-pane fade show active" id="summary" role="tabpanel">
                                    <h5>分析结果摘要</h5>
                                    <pre class="p-3 bg-light rounded" th:text="${result.summary}"></pre>
                                </div>
                                
                                <!-- 字段规则 -->
                                <div class="tab-pane fade" id="rules" role="tabpanel">
                                    <h5>字段规则</h5>
                                    <div id="rulesContainer">
                                        <!-- 在JavaScript中渲染 -->
                                    </div>
                                </div>
                                
                                <!-- 字段关系 -->
                                <div class="tab-pane fade" id="relations" role="tabpanel">
                                    <h5>字段关系</h5>
                                    <div id="relationsContainer">
                                        <!-- 在JavaScript中渲染 -->
                                    </div>
                                </div>
                                
                                <!-- 原始JSON -->
                                <div class="tab-pane fade" id="raw" role="tabpanel">
                                    <h5>原始JSON结果</h5>
                                    <pre class="p-3 bg-light rounded" id="rawJson" style="max-height: 500px; overflow: auto;"></pre>
                                </div>
                            </div>
                        </div>

                        <!-- 任务操作按钮 -->
                        <div class="task-actions mt-4">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <a th:if="${task.status == T(com.example.multidoc.model.AnalysisTask.TaskStatus).COMPLETED}" 
                                       th:href="@{/task/{id}/result(id=${task.id})}" 
                                       class="btn btn-success me-2">
                                        <i class="fas fa-chart-bar"></i> 查看结果
                                    </a>
                                    <button th:if="${task.status == T(com.example.multidoc.model.AnalysisTask.TaskStatus).CREATED}" 
                                            th:href="@{/task/{id}/execute(id=${task.id})}" 
                                            class="btn btn-primary me-2">
                                        <i class="fas fa-play"></i> 开始分析
                                    </button>
                                </div>
                                <div>
                                    <form th:action="@{/task/{id}/delete(id=${task.id})}" method="post" 
                                          onsubmit="return confirm('确定要删除此任务吗？此操作将删除任务及其所有相关文档，且不可恢复。');">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash"></i> 删除任务
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h3>分析配置</h3>
                            </div>
                            <div class="card-body">
                                <form id="analysisConfigForm">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="chunkSize" class="form-label">文本分块大小</label>
                                            <input type="number" class="form-control" id="chunkSize" 
                                                   name="chunkSize" min="100" max="5000" 
                                                   th:value="${config.chunkSize}">
                                            <div class="form-text">设置文本分块的大小（100-5000字符）</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="chunkOverlap" class="form-label">分块重叠大小</label>
                                            <input type="number" class="form-control" id="chunkOverlap" 
                                                   name="chunkOverlap" min="0" max="1000" 
                                                   th:value="${config.chunkOverlap}">
                                            <div class="form-text">设置分块之间的重叠大小（0-1000字符）</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="maxCategories" class="form-label">最大分类数量</label>
                                            <input type="number" class="form-control" id="maxCategories" 
                                                   name="maxCategories" min="1" max="20" 
                                                   th:value="${config.maxCategories}">
                                            <div class="form-text">设置Excel字段的最大分类数量（1-20）</div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">保存配置</button>
                                </form>
                            </div>
                        </div>

                        <!-- 分类选择区域 -->
                        <div class="card mb-4" id="categorySelectionCard" style="display: none;">
                            <div class="card-header">
                                <h3>选择分析分类</h3>
                            </div>
                            <div class="card-body">
                                <div class="row" id="categoryCheckboxes">
                                    <!-- 分类选项将通过JavaScript动态添加 -->
                                </div>
                                <button class="btn btn-primary mt-3" id="startAnalysisBtn">开始分析</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-light text-center">
        <div class="container">
            <p class="mb-0">© 2023 多文档分析系统 - 基于Spring Boot和Spring AI</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 仅在有结果的情况下执行
            const resultJsonElement = document.getElementById('rawJson');
            if (!resultJsonElement) return;
            
            // 获取结果JSON并解析
            const resultJson = /*[[${result != null ? result.resultJson : '{}'}]]*/ '{}';
            try {
                const resultData = JSON.parse(resultJson);
                
                // 显示原始JSON
                resultJsonElement.textContent = JSON.stringify(resultData, null, 2);
                
                // 渲染规则
                if (resultData.compiledRules) {
                    const rulesContainer = document.getElementById('rulesContainer');
                    let rulesHtml = '';
                    
                    for (const fieldName in resultData.compiledRules) {
                        rulesHtml += `<div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <strong>${fieldName}</strong>
                                        </div>
                                        <div class="card-body">
                                            <h6>显式规则:</h6>
                                            <ul>`;
                        
                        const rules = resultData.compiledRules[fieldName];
                        if (rules.explicitRules && rules.explicitRules.length > 0) {
                            rules.explicitRules.forEach(rule => {
                                rulesHtml += `<li><span class="badge bg-primary me-2">${rule.priority || 1}</span> ${rule.rule}</li>`;
                            });
                        } else {
                            rulesHtml += `<li class="text-muted">无显式规则</li>`;
                        }
                        
                        rulesHtml += `</ul>
                                    <h6 class="mt-3">隐含规则:</h6>
                                    <ul>`;
                        
                        if (rules.implicitRules && rules.implicitRules.length > 0) {
                            rules.implicitRules.forEach(rule => {
                                rulesHtml += `<li><span class="badge bg-secondary me-2">${rule.priority || 1}</span> ${rule.rule}</li>`;
                            });
                        } else {
                            rulesHtml += `<li class="text-muted">无隐含规则</li>`;
                        }
                        
                        rulesHtml += `</ul>
                                    </div>
                                </div>`;
                    }
                    
                    rulesContainer.innerHTML = rulesHtml;
                }
                
                // 渲染关系
                if (resultData.report && resultData.report.fieldRelations) {
                    const relationsContainer = document.getElementById('relationsContainer');
                    let relationsHtml = '<div class="table-responsive"><table class="table table-striped">';
                    relationsHtml += '<thead><tr><th>源字段</th><th>目标字段</th><th>相关性</th><th>描述</th></tr></thead><tbody>';
                    
                    resultData.report.fieldRelations.forEach(relation => {
                        const scoreClass = relation.score >= 0.7 ? 'bg-success' : 
                                          relation.score >= 0.4 ? 'bg-warning' : 'bg-danger';
                        
                        relationsHtml += `<tr>
                                            <td>${relation.sourceField}</td>
                                            <td>${relation.targetField}</td>
                                            <td><span class="badge ${scoreClass}">${relation.score.toFixed(2)}</span></td>
                                            <td>${relation.description || ''}</td>
                                          </tr>`;
                    });
                    
                    relationsHtml += '</tbody></table></div>';
                    relationsContainer.innerHTML = relationsHtml;
                }
                
            } catch (e) {
                console.error('解析结果JSON失败:', e);
                resultJsonElement.textContent = '解析结果JSON失败: ' + e.message;
            }
        });
        
        // 如果任务正在处理中，自动刷新页面
        const taskStatus = /*[[${task.status.name()}]]*/ '';
        if (taskStatus === 'PROCESSING') {
            setTimeout(() => {
                window.location.reload();
            }, 5000); // 5秒后刷新
        }
    </script>
    <script th:inline="javascript">
        // 获取任务ID和状态
        const taskId = [[${task.id}]];
        const currentTaskStatus = [[${task.status}]];
        
        // 如果任务正在处理中，启动进度更新
        if (currentTaskStatus === 'PROCESSING') {
            updateProgress();
        }
        
        // 更新进度信息
        function updateProgress() {
            fetch(`/api/task/${taskId}/status`)
                .then(response => response.json())
                .then(data => {
                    // 更新进度条
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = `${data.percentage}%`;
                    progressBar.textContent = `${data.percentage}%`;
                    
                    // 更新步骤信息
                    updateSteps(data.steps);
                    
                    // 如果任务还在处理中，继续更新
                    if (data.currentStep > 0 && data.currentStep < 6) {
                        setTimeout(updateProgress, 2000); // 每2秒更新一次
                    } else if (data.currentStep === 6) {
                        // 任务完成，刷新页面
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('获取进度信息失败:', error);
                });
        }
        
        // 更新步骤信息
        function updateSteps(steps) {
            const container = document.getElementById('stepsContainer');
            container.innerHTML = '';
            
            steps.forEach(step => {
                const stepElement = document.createElement('div');
                stepElement.className = `step-item ${step.status}`;
                
                let statusText = '';
                let statusClass = '';
                switch (step.status) {
                    case 'completed':
                        statusText = '已完成';
                        statusClass = 'completed';
                        break;
                    case 'in_progress':
                        statusText = '处理中';
                        statusClass = 'in-progress';
                        break;
                    case 'pending':
                        statusText = '等待中';
                        statusClass = 'pending';
                        break;
                }
                
                stepElement.innerHTML = `
                    <div class="step-header">
                        <h5 class="mb-0">${step.name}</h5>
                        <span class="step-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="step-details">
                        ${formatStepDetails(step.details)}
                    </div>
                `;
                
                container.appendChild(stepElement);
            });
        }
        
        // 格式化步骤详情
        function formatStepDetails(details) {
            let html = '<ul class="list-unstyled mb-0">';
            
            for (const [key, value] of Object.entries(details)) {
                const label = formatLabel(key);
                html += `<li><strong>${label}：</strong> ${value}</li>`;
            }
            
            html += '</ul>';
            return html;
        }
        
        // 格式化标签
        function formatLabel(key) {
            const labels = {
                'totalFiles': '总文件数',
                'processedFiles': '已处理文件数',
                'totalChunks': '总文本块数',
                'totalFields': '总字段数',
                'fieldsWithText': '已提取文本字段数',
                'totalPossibleRelations': '可能的字段关系数',
                'evaluatedRelations': '已评估关系数',
                'fieldsWithRules': '已提取规则字段数',
                'totalRules': '总规则数',
                'explicitRules': '显式规则数',
                'implicitRules': '隐式规则数',
                'hasResult': '是否生成结果',
                'completedTime': '完成时间',
                'hasError': '是否有错误'
            };
            
            return labels[key] || key;
        }
        
        // 开始分析
        function startAnalysis() {
            fetch(`/api/task/${taskId}/start`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('启动分析失败');
                }
            })
            .catch(error => {
                console.error('启动分析失败:', error);
                alert('启动分析失败');
            });
        }

        // 保存配置
        document.getElementById('analysisConfigForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const config = {
                chunkSize: parseInt(document.getElementById('chunkSize').value),
                chunkOverlap: parseInt(document.getElementById('chunkOverlap').value),
                maxCategories: parseInt(document.getElementById('maxCategories').value)
            };
            
            fetch('/api/config/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('配置已保存');
                } else {
                    alert('保存配置失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存配置时发生错误');
            });
        });

        // 处理分类选择
        function showCategorySelection(categories) {
            const container = document.getElementById('categoryCheckboxes');
            container.innerHTML = '';
            
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'col-md-4 mb-3';
                div.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               value="${category.categoryName}" 
                               id="category_${category.categoryName}">
                        <label class="form-check-label" for="category_${category.categoryName}">
                            ${category.categoryName}
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('categorySelectionCard').style.display = 'block';
        }

        // 开始分析选中的分类
        document.getElementById('startAnalysisBtn').addEventListener('click', function() {
            const selectedCategories = Array.from(document.querySelectorAll('.form-check-input:checked'))
                .map(checkbox => checkbox.value);
                
            if (selectedCategories.length === 0) {
                alert('请至少选择一个分类');
                return;
            }
            
            fetch('/api/analysis/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    taskId: /*[[${task.id}]]*/,
                    selectedCategories: selectedCategories
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('开始分析失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('开始分析时发生错误');
            });
        });
    </script>
</body>
</html> 